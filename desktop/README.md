# Insurance Management System - Desktop Application

Настольное приложение системы управления страхованием на базе Electron + React + TypeScript.

## Требования

- Node.js 18+ 
- npm или yarn
- Windows 10/11

## Установка и запуск

### 1. Установка зависимостей

```cmd
cd desktop
npm install
```

### 2. Режим разработки

```cmd
npm run dev
```

Эта команда:
- Запустит Vite dev server на порту 5173 (`dev:vite`)
- Дождётся готовности сервера через `wait-on tcp:5173`
- Автоматически запустит Electron только после старта Vite (`dev:electron`)
- Откроет DevTools для отладки
- Использует `concurrently` для параллельного запуска процессов

**Важно**: Electron НЕ откроется до тех пор, пока Vite не запустится на порту 5173, что исключает ошибки `ERR_CONNECTION_REFUSED`.

### 3. Продакшн сборка

```cmd
npm run build
```

Эта команда:
- Соберет renderer (React) в `dist/renderer`
- Скомпилирует main process в `dist/main`

### 4. Запуск собранной версии

```cmd
npm start
```

## Архитектура

```
desktop/
├── src/
│   ├── main/           # Main process (Electron)
│   │   ├── main.ts     # Главный файл приложения
│   │   └── preload.ts  # Preload скрипт для безопасности
│   └── renderer/       # Renderer process (React)
│       ├── components/ # React компоненты
│       ├── services/   # API сервисы
│       ├── App.tsx     # Главный React компонент
│       ├── App.css     # Стили приложения
│       ├── main.tsx    # Точка входа React
│       ├── index.html  # HTML шаблон
│       └── polyfills.ts # Полифиллы для Node.js API
├── dist/               # Собранные файлы
├── package.json        # Зависимости и скрипты
├── tsconfig.json       # TypeScript конфиг для renderer
├── tsconfig.main.json  # TypeScript конфиг для main
└── vite.renderer.ts    # Vite конфигурация
```

## Безопасность

- **Context Isolation**: Включена изоляция контекста между main и renderer
- **Node Integration**: Отключена интеграция Node.js в renderer
- **Sandbox**: Включен sandbox режим
- **CSP**: Настроена Content Security Policy без unsafe-eval
- **Preload Script**: Безопасная связь между процессами

## Возможности

### Аутентификация
- Вход в систему
- Регистрация новых пользователей
- Автоматическая проверка токена
- Безопасный выход из системы

### Интерфейс
- Современный UI на React
- Адаптивный дизайн
- Плавные анимации и переходы
- Обработка ошибок и состояний загрузки

### Интеграция с API
- Подключение к backend сервисам
- Автоматическое управление токенами
- Обработка ошибок сети

## API Endpoints

Приложение подключается к следующим сервисам:

- **Auth Service**: `http://localhost:8001`
  - `POST /auth/login` - Вход в систему
  - `POST /auth/register` - Регистрация
  - `POST /auth/logout` - Выход
  - `POST /auth/verify-token` - Проверка токена

## Роли пользователей

- **Клиент** - базовый доступ
- **Агент** - работа с клиентами и договорами
- **Менеджер** - расширенные права управления
- **Администратор** - полный доступ к системе

## Разработка

### Структура компонентов

- `App.tsx` - Главный компонент с логикой аутентификации
- `LoginForm.tsx` - Форма входа в систему
- `RegisterForm.tsx` - Форма регистрации
- `Dashboard.tsx` - Панель управления для авторизованных пользователей

### Сервисы

- `AuthService` - Управление аутентификацией и API запросами

### Стили

Используется CSS с современными возможностями:
- CSS Grid и Flexbox
- CSS переменные
- Анимации и переходы
- Адаптивный дизайн

## Дополнительные команды

### Отдельные скрипты для разработки

```cmd
# Запуск только Vite сервера
npm run dev:vite

# Запуск только Electron (после запуска Vite)
npm run dev:electron
```

## Устранение неполадок

### Белый экран при запуске
- Проверьте, что backend сервисы запущены
- Убедитесь, что все зависимости установлены
- Проверьте консоль DevTools на наличие ошибок
- В main процессе теперь есть fallback на prod-файлы при ошибке загрузки dev-сервера

### Ошибки соединения в dev-режиме
- `ERR_CONNECTION_REFUSED` больше не должно происходить благодаря `wait-on`
- Если всё равно возникает, проверьте, что порт 5173 свободен
- Electron автоматически попробует загрузить prod-файлы при ошибке

### Ошибки CSP
- Все внешние ресурсы должны быть в allowlist CSP
- Избегайте использования `eval()` и inline скриптов

### Проблемы с аутентификацией
- Убедитесь, что auth-service запущен на порту 8001
- Проверьте правильность endpoints в AuthService

## Сборка для продакшена

```cmd
# Полная сборка
npm run build

# Создание установщика (требует дополнительной настройки)
npm run dist
```

## Версии

- **Electron**: 30.0.0
- **React**: 18.2.0
- **TypeScript**: 5.4.5
- **Vite**: 5.2.0 